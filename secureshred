#!/bin/bash

# SecureShred - Secure File Deletion Tool
# Version: 1.0.0

VERSION="1.0.0"
SCRIPT_NAME="secureshred"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

print_success() { echo -e "${GREEN}âœ“${NC} $1"; }
print_error() { echo -e "${RED}âœ—${NC} $1"; }
print_info() { echo -e "${BLUE}â„¹${NC} $1"; }
print_warning() { echo -e "${YELLOW}âš ${NC} $1"; }
print_header() { echo -e "${CYAN}${BOLD}${1}${NC}"; }
print_critical() { echo -e "${RED}${BOLD}ğŸ”¥${NC} $1"; }

# Log directory
LOG_DIR="$HOME/.secureshred"
LOG_FILE="$LOG_DIR/shred.log"
mkdir -p "$LOG_DIR"

# Default settings
PASSES=3
METHOD="dod"
FORCE=false
VERBOSE=false

show_usage() {
    cat << EOF
${BLUE}${BOLD}SecureShred${NC} - Secure File Deletion Tool v${VERSION}

${YELLOW}Usage:${NC}
    $SCRIPT_NAME [options] <file/directory>

${YELLOW}Options:${NC}
    -p, --passes <n>        Number of overwrite passes (default: 3)
    -m, --method <method>   Shredding method (dod, gutmann, random)
    -f, --force             Skip confirmation prompts
    -v, --verbose           Verbose output
    -r, --recursive         Shred directories recursively
    --verify                Verify file is unrecoverable after shred
    --log                   Show shred log

${YELLOW}Methods:${NC}
    dod                     DoD 5220.22-M (3 passes) - Default
    gutmann                 Gutmann method (35 passes) - Most secure
    random                  Random data (custom passes)

${YELLOW}Options:${NC}
    -h, --help              Show this help
    -v, --version           Show version

${YELLOW}Examples:${NC}
    $SCRIPT_NAME secret.txt
        â†’ Shred file with default method (3 passes)

    $SCRIPT_NAME -p 7 confidential.pdf
        â†’ Shred with 7 random passes

    $SCRIPT_NAME -m gutmann sensitive/
        â†’ Shred directory with Gutmann method

    $SCRIPT_NAME -f old_data/*
        â†’ Force shred multiple files

    $SCRIPT_NAME --log
        â†’ View shredding history

${YELLOW}Shredding Methods Explained:${NC}

${BOLD}DoD 5220.22-M (3 passes):${NC}
    Pass 1: Write zeros
    Pass 2: Write ones
    Pass 3: Write random data
    Standard for government data destruction

${BOLD}Gutmann (35 passes):${NC}
    Most thorough method
    Designed to defeat all known recovery techniques
    Very slow but maximally secure

${BOLD}Random (custom passes):${NC}
    Overwrite with random data N times
    Fast and effective for most use cases

${YELLOW}âš ï¸  WARNING:${NC}
    ${RED}SHREDDED FILES CANNOT BE RECOVERED!${NC}
    This is permanent and irreversible.
    Always verify you're shredding the right files!

EOF
}

show_version() {
    echo "$SCRIPT_NAME version $VERSION"
}

# Log shred operation
log_shred() {
    local file="$1"
    local method="$2"
    local passes="$3"
    echo "$(date '+%Y-%m-%d %H:%M:%S') | $method | $passes passes | $file" >> "$LOG_FILE"
}

# Show log
show_log() {
    if [ ! -f "$LOG_FILE" ]; then
        print_info "No shred history yet"
        return 0
    fi
    
    print_header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    print_header "                    SHREDDING HISTORY"
    print_header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    cat "$LOG_FILE" | tail -50
    
    echo ""
    print_info "Showing last 50 operations"
}

# Verify shred tool availability
check_shred_tool() {
    if ! command -v shred &> /dev/null; then
        print_error "shred command not found"
        print_info "Install: sudo apt install coreutils"
        return 1
    fi
    return 0
}

# Get file size
get_file_size() {
    local file="$1"
    if [ -f "$file" ]; then
        stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null
    else
        echo "0"
    fi
}

# Format bytes
format_bytes() {
    local bytes=$1
    if [ "$bytes" -lt 1024 ]; then
        echo "${bytes}B"
    elif [ "$bytes" -lt 1048576 ]; then
        echo "$((bytes / 1024))KB"
    elif [ "$bytes" -lt 1073741824 ]; then
        echo "$((bytes / 1048576))MB"
    else
        echo "$((bytes / 1073741824))GB"
    fi
}

# Shred single file
shred_file() {
    local file="$1"
    local passes="$2"
    local method="$3"
    
    if [ ! -f "$file" ]; then
        print_error "File not found: $file"
        return 1
    fi
    
    local size=$(get_file_size "$file")
    local size_fmt=$(format_bytes "$size")
    
    if [ "$VERBOSE" = true ]; then
        print_info "Shredding: $file ($size_fmt)"
    fi
    
    # DoD method
    if [ "$method" = "dod" ]; then
        shred -vfz -n 3 "$file" 2>&1 | grep -v "shred:" || true
    # Gutmann method
    elif [ "$method" = "gutmann" ]; then
        shred -vfz -n 35 "$file" 2>&1 | grep -v "shred:" || true
    # Random method
    else
        shred -vfz -n "$passes" "$file" 2>&1 | grep -v "shred:" || true
    fi
    
    # Remove file
    rm -f "$file"
    
    if [ ! -f "$file" ]; then
        print_success "Shredded: $file"
        log_shred "$file" "$method" "$passes"
        return 0
    else
        print_error "Failed to shred: $file"
        return 1
    fi
}

# Shred directory
shred_directory() {
    local dir="$1"
    local passes="$2"
    local method="$3"
    
    if [ ! -d "$dir" ]; then
        print_error "Directory not found: $dir"
        return 1
    fi
    
    print_info "Scanning directory: $dir"
    
    local count=0
    local total=0
    
    # Count files
    total=$(find "$dir" -type f | wc -l)
    
    if [ "$total" -eq 0 ]; then
        print_warning "No files found in directory"
        return 0
    fi
    
    print_info "Found $total files to shred"
    echo ""
    
    # Shred each file
    while IFS= read -r file; do
        ((count++))
        echo -ne "\rProgress: $count/$total"
        shred_file "$file" "$passes" "$method" > /dev/null 2>&1
    done < <(find "$dir" -type f)
    
    echo ""
    echo ""
    
    # Remove empty directory
    find "$dir" -type d -empty -delete 2>/dev/null
    
    if [ ! -d "$dir" ]; then
        print_success "Shredded directory: $dir ($total files)"
    else
        print_warning "Directory still exists (may contain subdirectories)"
    fi
}

# Main shred function
perform_shred() {
    local target="$1"
    
    check_shred_tool || return 1
    
    # Expand wildcards
    local targets=()
    for item in $target; do
        if [ -e "$item" ]; then
            targets+=("$item")
        fi
    done
    
    if [ ${#targets[@]} -eq 0 ]; then
        print_error "No files or directories found matching: $target"
        return 1
    fi
    
    # Show what will be shredded
    print_header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    print_critical "SECURE SHRED OPERATION"
    print_header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    print_warning "Method: $METHOD ($PASSES passes)"
    print_warning "Targets:"
    
    local total_size=0
    for item in "${targets[@]}"; do
        if [ -f "$item" ]; then
            local size=$(get_file_size "$item")
            total_size=$((total_size + size))
            echo "  â€¢ $item ($(format_bytes $size))"
        elif [ -d "$item" ]; then
            local file_count=$(find "$item" -type f | wc -l)
            echo "  â€¢ $item/ ($file_count files)"
        fi
    done
    
    echo ""
    print_critical "THIS IS PERMANENT AND IRREVERSIBLE!"
    print_warning "Shredded data CANNOT be recovered!"
    echo ""
    
    if [ "$FORCE" = false ]; then
        read -p "Type 'SHRED' to confirm: " confirmation
        if [ "$confirmation" != "SHRED" ]; then
            print_info "Cancelled"
            return 0
        fi
    fi
    
    echo ""
    print_info "Starting secure shred..."
    echo ""
    
    # Perform shredding
    local success=0
    local failed=0
    
    for item in "${targets[@]}"; do
        if [ -f "$item" ]; then
            if shred_file "$item" "$PASSES" "$METHOD"; then
                ((success++))
            else
                ((failed++))
            fi
        elif [ -d "$item" ]; then
            if shred_directory "$item" "$PASSES" "$METHOD"; then
                ((success++))
            else
                ((failed++))
            fi
        fi
    done
    
    echo ""
    print_header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    print_header "                    SHRED COMPLETE"
    print_header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    [ $success -gt 0 ] && print_success "Successfully shredded: $success"
    [ $failed -gt 0 ] && print_error "Failed to shred: $failed"
    
    echo ""
}

# Parse arguments
POSITIONAL=()
while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--passes)
            PASSES="$2"
            METHOD="random"
            shift 2
            ;;
        -m|--method)
            METHOD="$2"
            shift 2
            ;;
        -f|--force)
            FORCE=true
            shift
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        -r|--recursive)
            RECURSIVE=true
            shift
            ;;
        --log)
            show_log
            exit 0
            ;;
        -h|--help)
            show_usage
            exit 0
            ;;
        --version)
            show_version
            exit 0
            ;;
        -*)
            print_error "Unknown option: $1"
            exit 1
            ;;
        *)
            POSITIONAL+=("$1")
            shift
            ;;
    esac
done

set -- "${POSITIONAL[@]}"

# Validate method
case "$METHOD" in
    dod)
        PASSES=3
        ;;
    gutmann)
        PASSES=35
        ;;
    random)
        # Use provided passes or default
        ;;
    *)
        print_error "Unknown method: $METHOD"
        print_info "Valid methods: dod, gutmann, random"
        exit 1
        ;;
esac

# Check if target provided
if [ $# -eq 0 ]; then
    show_usage
    exit 1
fi

# Perform shred
perform_shred "$@"
