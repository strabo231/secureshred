name: Test SecureShred

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test on Ubuntu
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Make script executable
      run: chmod +x secureshred
    
    - name: Test help command
      run: ./secureshred --help
    
    - name: Test version command
      run: ./secureshred --version
    
    - name: Create test files
      run: |
        mkdir -p test-shred
        echo "test data 1" > test-shred/test1.txt
        echo "test data 2" > test-shred/test2.txt
        echo "test data 3" > test-shred/test3.txt
    
    - name: Test DoD shredding
      run: echo "SHRED" | ./secureshred test-shred/test1.txt
    
    - name: Verify file was deleted
      run: |
        if [ -f test-shred/test1.txt ]; then
          echo "❌ File still exists!"
          exit 1
        else
          echo "✓ File successfully shredded"
        fi
    
    - name: Test custom passes
      run: echo "SHRED" | ./secureshred -p 5 test-shred/test2.txt
    
    - name: Test Gutmann method
      run: echo "SHRED" | ./secureshred -m gutmann test-shred/test3.txt
    
    - name: Create directory for recursive test
      run: |
        mkdir -p test-dir
        echo "file1" > test-dir/file1.txt
        echo "file2" > test-dir/file2.txt
    
    - name: Test recursive shredding
      run: echo "SHRED" | ./secureshred -r test-dir
    
    - name: Test log viewing
      run: ./secureshred --log || true
    
    - name: Install shellcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck
    
    - name: Run shellcheck
      continue-on-error: true
      run: shellcheck secureshred
    
    - name: Verify script structure
      run: |
        grep -q "shred_file()" secureshred
        grep -q "dod_method()" secureshred
        grep -q "gutmann_method()" secureshred
        echo "✓ Script structure verified"
    
    - name: All tests passed
      run: |
        echo "================================"
        echo "✓ All tests passed successfully!"
        echo "================================"
